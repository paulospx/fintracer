@{
    ViewData["Title"] = "Fin Tracer - Compare Files";
}

<div class="text-center">
    <h1>Compare</h1>
    <p>Compares curves of 2 Super Set excel files.</p>

</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="periodSelect" class="form-label">Select Period</label>
        <select id="periodSelect" class="form-select" onchange="showComparison();">
            <option value="" disabled selected>Loading periods...</option>
        </select>
    </div>
    <div class="col-md-4">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="up">
            <label class="form-check-label" for="up">Up</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="down">
            <label class="form-check-label" for="down">Down</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cra">
            <label class="form-check-label" for="cra">CRA</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="delta-ladders">
            <label class="form-check-label" for="delta-ladders">Delta Ladders</label>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="lip">
            <label class="form-check-label" for="lip">LIP</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="aegon">
            <label class="form-check-label" for="aegon">Aegon</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="asr">
            <label class="form-check-label" for="asr">ASR</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="flattener">
            <label class="form-check-label" for="flattener">Flattener</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="steepener">
            <label class="form-check-label" for="steepener">Steepener</label>
        </div>
    </div>
</div>


<!-- Charts-->
<div class="row">
    <div class="col-sm-6">
        <h2>Container 1</h2>
        <div id="container1"></div>
    </div>
    <div class="col-sm-6">
        <h2>Container 2</h2>
        <div id="container2"></div>
    </div>
</div>
<div id="comp">
</div>

<script>
    Highcharts.setOptions({
        colors: ['#4ACB82', '#8EE6EF', '#FF40EA', '#7872C0', '#E92531', '#FFB900', '#969696', '#FF409B'], // a.s.r. Palette
    });

    const series = [{
        name: 'Athletics',
        id: 'athletics',
        marker: {
            symbol: 'circle'
        }
    },
    {
        name: 'Triathlon',
        id: 'triathlon',
        marker: {
            symbol: 'triangle'
        }
    },
    {
        name: 'Volleyball',
        id: 'volleyball',
        marker: {
            symbol: 'square'
        }
    }];


async function getData() {
    const response = await fetch(
        '/data/olympic2012.json'
    );
    return response.json();
}

getData().then(data => {
    const getData = sportName => {
        const temp = [];
        data.forEach(elm => {
            if (elm.sport === sportName && elm.weight > 0 && elm.height > 0) {
                temp.push([elm.height, elm.weight]);
            }
        });
        return temp;
    };
    series.forEach(s => {
        s.data = getData(s.id);
    });


    Highcharts.chart('container1', {
        chart: {
            type: 'scatter',
            zooming: {
                type: 'xy'
            }
        },
        title: {
            text: 'Olympics athletes by height and weight'
        },
        subtitle: {
            text: 'Source file Here'
        },
        xAxis: {
            title: {
                text: 'Height'
            },
            labels: {
                format: '{value} m'
            },
            startOnTick: true,
            endOnTick: true,
            showLastLabel: true
        },
        yAxis: {
            title: {
                text: 'Weight'
            },
            labels: {
                format: '{value} kg'
            }
        },
        legend: {
            enabled: true
        },
        plotOptions: {
            scatter: {
                marker: {
                    radius: 2.5,
                    symbol: 'circle',
                    states: {
                        hover: {
                            enabled: true,
                            lineColor: 'rgb(100,100,100)'
                        }
                    }
                },
                states: {
                    hover: {
                        marker: {
                            enabled: false
                        }
                    }
                },
                jitter: {
                    x: 0.005
                }
            }
        },
        tooltip: {
            pointFormat: 'Height: {point.x} m <br /> Weight: {point.y} kg'
        },
        series
    });

    Highcharts.chart('container2', {
        chart: {
            type: 'scatter',
            zooming: {
                type: 'xy'
            }
        },
        title: {
            text: 'Olympics athletes by height and weight'
        },
        subtitle: {
            text: 'Source file Here'
        },
        xAxis: {
            title: {
                text: 'Height'
            },
            labels: {
                format: '{value} m'
            },
            startOnTick: true,
            endOnTick: true,
            showLastLabel: true
        },
        yAxis: {
            title: {
                text: 'Weight'
            },
            labels: {
                format: '{value} kg'
            }
        },
        legend: {
            enabled: true
        },
        plotOptions: {
            scatter: {
                marker: {
                    radius: 2.5,
                    symbol: 'circle',
                    states: {
                        hover: {
                            enabled: true,
                            lineColor: 'rgb(100,100,100)'
                        }
                    }
                },
                states: {
                    hover: {
                        marker: {
                            enabled: false
                        }
                    }
                },
                jitter: {
                    x: 0.005
                }
            }
        },
        tooltip: {
            pointFormat: 'Height: {point.x} m <br /> Weight: {point.y} kg'
        },
        series
    });
});

    function createChart(id, title, data) {
        Highcharts.chart(id, {
            title: {
                text: title,
                align: 'left'
            },

            subtitle: {
                text: 'By a.s.r. ARM Team.',
                align: 'left'
            },

            yAxis: {
                title: {
                    text: 'Value'
                }
            },

            xAxis: {
                accessibility: {
                    rangeDescription: 'Maturities'
                },
                categories: []
            },

            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },

            plotOptions: {
                series: {
                    label: {
                        connectorAllowed: false
                    },
                    pointStart: 0
                }
            },

            series: data,

            responsive: {
                rules: [{
                    condition: {
                        maxWidth: 500
                    },
                    chartOptions: {
                        legend: {
                            layout: 'horizontal',
                            align: 'center',
                            verticalAlign: 'bottom'
                        }
                    }
                }]
            }
        });
    }

    function createChartDivs(total) {
        var html = "";
        for (i=1; i<=total; i=i+1) {
            html += `<div class="row">
        <div class="col-sm-6">
            <h2></h2>
            <div id="comparison${i}"></div>
        </div>
        <div class="col-sm-6">
            <h2></h2>
             <div id="comparison.delta${i}"></div>
        </div>
    </div>`;
        }
        $("#comp").html(html);
    }

    function chartTitle(title) {
        if (title.length > 20) {
            return title.substr(0,20) + "..." ;
        }
        return title;
    }

    function getCheckedCheckboxes() {
        const checkedValues = [];
        $('.form-check-input:checked').each(function () {
            checkedValues.push($(this).attr('id'));
        });
        return checkedValues;
    }


    function showComparison() {
        var period = $("#periodSelect").val();

        $.get("/Compare/Categories", {period:period, text:getCheckedValuesCSV()},function(result) {
            createChartDivs(result.length);
            var i = 1;
            result.forEach(function(comparison){
                var series = [
                    { name : chartTitle(comparison.title), data : JSON.parse(comparison.sourceCurve)},
                    { name : chartTitle(comparison.title), data : JSON.parse(comparison.targetCurve)}
                ];

                createChart(`comparison${i}`,"Curves " + comparison.title, series);

                var deltaSeries = [
                        { name : chartTitle(comparison.title), data : JSON.parse(comparison.delta)}
                ]

                createChart(`comparison.delta${i}`,"Delta " + comparison.title, deltaSeries);
                i=i+1;
            });
        });
        }


    $(document).ready(function () {
        $.get("/Compare/Periods", function (data) {
            const periodSelect = $("#periodSelect");
            periodSelect.empty(); // Clear existing options

            // Populate the select box with periods
            if (data && data.length > 0) {
                periodSelect.append('<option value="" disabled selected>Select a period</option>');
                data.forEach(period => {
                    periodSelect.append(`<option value="${period}">${period}</option>`);
                });
            } else {
                periodSelect.append('<option value="" disabled>No periods available</option>');
            }
        }).fail(function () {
            // Handle errors
            const periodSelect = $("#periodSelect");
            periodSelect.empty();
            periodSelect.append('<option value="" disabled>Error loading periods</option>');
        });


    });
</script>